{% load static %}
<!DOCTYPE html>
<html lang="en" class="scroll-smooth overflow-hidden">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Recovery | Eduke</title>

    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
    <link rel="icon" type="image/png" href="{% static 'images/logobase_white.png' %}">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: {
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            accent: '#00f2ff'
                        }
                    },
                    animation: {
                        'gradient-fast': 'gradient-shift 8s ease infinite',
                        'tilt': 'tilt 10s infinite linear',
                        'float': 'float 5s ease-in-out infinite',
                        'pulse-slow': 'pulse 6s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        'gradient-shift': {
                            '0%, 100%': { 'background-position': '0% 50%' },
                            '50%': { 'background-position': '100% 50%' },
                        },
                        tilt: {
                            '0%, 50%, 100%': { transform: 'rotate(0deg)' },
                            '25%': { transform: 'rotate(0.8deg)' },
                            '75%': { transform: 'rotate(-0.8deg)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0) scale(1)' },
                            '50%': { transform: 'translateY(-15px) scale(1.05)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --bg-light: linear-gradient(-45deg, #f0f2f5, #e0e7ff, #ede9fe, #dcfce7, #f5f3ff);
            --bg-dark: linear-gradient(-45deg, #050810, #0f172a, #1e1b4b, #020617, #0f172a);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: var(--bg-light);
            background-size: 300% 300%;
            animation: gradient-shift 12s ease infinite;
            position: relative;
        }

        .dark body {
            background: var(--bg-dark);
            background-size: 300% 300%;
        }

        /* Animated Mesh Blobs */
        .blob {
            position: absolute;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.4;
        }

        .blob-1 {
            background: #8b5cf6;
            top: -10%;
            left: -10%;
            animation: float 10s infinite;
        }

        .blob-2 {
            background: #00f2ff;
            bottom: -10%;
            right: -10%;
            animation: float 8s infinite reverse;
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        .error-shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .message-hidden {
            opacity: 0;
            transform: translate(-50%, -20px) scale(0.9);
            pointer-events: none;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0) scale(1);
            }

            50% {
                transform: translateY(-15px) scale(1.05);
            }
        }

        .super-glass {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(25px) saturate(200%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
        }

        .dark .super-glass {
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.4);
        }

        .cyber-bar {
            height: 4px;
            flex: 1;
            border-radius: 10px;
            background: rgba(124, 58, 237, 0.1);
            overflow: hidden;
            position: relative;
        }

        .cyber-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: #7c3aed;
            transform: translateX(-100%);
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cyber-bar.completed::after {
            transform: translateX(0);
        }

        .cyber-bar.active::after {
            transform: translateX(0);
            background: linear-gradient(90deg, #7c3aed, #c084fc, #7c3aed);
            background-size: 200% 100%;
            animation: shimmer 2s infinite linear;
        }

        /* Toast Styles */
        #toast-container {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            pointer-events: none;
            align-items: center;
        }

        .toast {
            pointer-events: auto;
            min-width: 280px;
            max-width: 400px;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 100px;
            /* Pill style */
            padding: 0.75rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative;
            animation: toast-in 0.5s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }

        .dark .toast {
            background: #1e293b;
            border: 1px solid #334155;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
        }

        @keyframes toast-progress-shrink {
            from {
                transform: scaleX(1);
            }

            to {
                transform: scaleX(0);
            }
        }


        @keyframes toast-in {
            from {
                transform: translateY(-40px) scale(0.95);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .toast.hiding {
            animation: toast-out 0.4s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }

        @keyframes toast-out {
            from {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            to {
                transform: translateY(20px) scale(0.9);
                opacity: 0;
            }
        }

        .loader {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="transition-colors duration-1000 flex items-center justify-center">

    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <button id="theme-toggle"
        class="fixed top-8 right-8 super-glass p-4 rounded-2xl hover:scale-110 active:scale-95 transition-all group z-50">
        <i id="theme-icon" class="fas fa-moon text-slate-600 dark:text-yellow-400 text-lg"></i>
    </button>

    <div class="w-full max-w-[460px] px-4">
        <div class="super-glass rounded-[4rem] p-12 lg:p-16 animate-tilt relative group animate__animated animate__fadeIn"
            data-aos="fade-up" data-aos-duration="1000">

            <div class="text-center mb-6">
                <div class="relative inline-flex mb-4 animate__animated animate__bounceIn">
                    <div class="absolute inset-0 bg-brand-purple blur-xl opacity-20 animate-pulse"></div>
                    <div class="relative p-3 rounded-xl bg-gradient-to-br from-brand-600 to-brand-500 text-white shadow-2xl shadow-brand-600/40">
                        <i id="header-icon" data-lucide="shield" class="w-6 h-6 text-white" fill="white"></i>
                    </div>
                </div>
                <h2 class="text-xl font-extrabold tracking-tight mb-1 text-slate-800 dark:text-white">Security Recovery
                </h2>
                <p id="step-desc"
                    class="text-brand-600 dark:text-white text-[9px] font-black uppercase tracking-[0.3em]">
                    Phase 01: Identity Link
                </p>
            </div>

            <div class="flex items-center justify-between gap-3 mb-8">
                <div id="bar-1" class="cyber-bar active"></div>
                <div id="bar-2" class="cyber-bar"></div>
                <div id="bar-3" class="cyber-bar"></div>
            </div>

            <!-- Step 1: Forgot Form -->
            <form id="forgotForm"
            data-user-type="{{ user_type }}"
                class="space-y-4 animate__animated animate__fadeInUp animate__faster hover:animate__pulse">
                {% csrf_token %}
                <div class="space-y-1.5">
                    <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest ml-1">Registered
                        Email</label>
                    <div class="relative">
                        <i data-lucide="mail"
                            class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input type="email" name="email" id="userEmail"
                            class="w-full pl-11 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50 outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-brand-purple transition-all text-sm hover:shadow-md focus:shadow-lg focus:shadow-purple-500/10 text-slate-900 dark:text-white"
                            placeholder="email@example.com" required>
                    </div>
                </div>
                <button type="submit"
                    class="w-full bg-gradient-to-br from-brand-600 to-brand-500 hover:from-brand-700 hover:to-brand-600 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-brand-500/20 active:scale-[0.98] flex items-center justify-center gap-2 text-sm hover:shadow-xl hover:shadow-brand-500/30 transform transition duration-300 hover:-translate-y-1">
                    <span class="btn-text">Initialize Recovery</span>
                    <i data-lucide="arrow-right" class="w-4 h-4 text-white"></i>
                    <span class="loader hidden"></span>
                </button>
            </form>

            <!-- Step 2: OTP Form -->
            <form id="otpForm"
            data-user-type="{{ user_type }}"
                class="hidden space-y-6 animate__animated animate__fadeInRight animate__faster hover:animate__pulse">
                {% csrf_token %}
                <div class="text-center space-y-4">
                    <label class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">Verification
                        Token</label>
                    <input type="text" name="otp" id="otpInput" maxlength="6" class="w-full text-center tracking-[0.6em] text-3xl font-black py-4 rounded-xl border-2 border-slate-100 dark:border-slate-800 bg-transparent focus:border-brand-purple outline-none transition-all hover:shadow-md focus:shadow-lg focus:shadow-purple-500/10 
    text-slate-900 dark:text-white" placeholder="000000" required>

                    <div class="flex flex-col items-center gap-3">
                        <div
                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-purple-500/10 text-brand-purple text-[10px] font-bold">
                            <i data-lucide="clock" class="w-3 h-3"></i>
                            <span id="timer">03:00</span>
                        </div>
                        <button type="button" id="resendBtn" onclick="resendOTP()" disabled
                            class="text-[9px] font-bold uppercase tracking-widest text-slate-400 disabled:opacity-50 transition-all hover:text-brand-purple">
                            Resend Code
                        </button>
                    </div>
                </div>
                <button type="submit"
                    class="w-full bg-gradient-to-br from-brand-600 to-brand-500 hover:from-brand-700 hover:to-brand-600 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-brand-500/20 active:scale-[0.98] flex items-center justify-center gap-2 text-sm hover:shadow-xl hover:shadow-brand-500/30 transform transition duration-300 hover:-translate-y-1">
                    <span class="btn-text">Authorize Access</span>
                    <span class="loader hidden"></span>
                </button>
            </form>

            <!-- Step 3: Reset Form -->
            <form id="resetForm"
                class="hidden space-y-4 animate__animated animate__fadeInRight animate__faster hover:animate__pulse">
                {% csrf_token %}
                <div class="space-y-3">
                    <div class="relative">
    <i data-lucide="lock"
        class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
    <input type="password" id="new_pass" name="new_password"
        class="w-full pl-11 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50 outline-none focus:border-brand-purple transition-all text-sm hover:shadow-md focus:shadow-lg focus:shadow-purple-500/10 
        text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500"
        placeholder="New Password" required>
</div>

<div class="relative mt-4"> <i data-lucide="shield-check"
        class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
    <input type="password" id="conf_pass" name="confirm_password"
        class="w-full pl-11 pr-4 py-3 rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50/50 dark:bg-slate-900/50 outline-none focus:border-brand-purple transition-all text-sm hover:shadow-md focus:shadow-lg focus:shadow-purple-500/10 
        text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500"
        placeholder="Confirm Password" required>
</div>

                    <div
                        class="flex flex-wrap justify-center gap-x-4 gap-y-2 p-3 rounded-xl bg-slate-50 dark:bg-slate-900/80 border border-slate-100 dark:border-slate-800">
                        <div id="req-len"
                            class="flex items-center gap-1.5 text-[8px] font-black text-slate-400 uppercase tracking-tighter">
                            <i data-lucide="check-circle" class="w-3 h-3"></i> 6+ CHARS
                        </div>
                        <div id="req-up"
                            class="flex items-center gap-1.5 text-[8px] font-black text-slate-400 uppercase tracking-tighter">
                            <i data-lucide="check-circle" class="w-3 h-3"></i> MIXED CASE
                        </div>
                        <div id="req-sp"
                            class="flex items-center gap-1.5 text-[8px] font-black text-slate-400 uppercase tracking-tighter">
                            <i data-lucide="check-circle" class="w-3 h-3"></i> SYMBOL/DIGIT
                        </div>
                    </div>
                </div>
                <button type="submit"
                    class="w-full bg-brand-accent hover:opacity-90 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-emerald-500/10 transition-all flex items-center justify-center gap-2 text-sm hover:shadow-xl hover:shadow-emerald-500/20 transform transition duration-300 hover:-translate-y-1">
                    <span class="btn-text">Update Password</span>
                    <span class="loader hidden"></span>
                </button>
            </form>

            <div id="successState" class="hidden text-center py-4 animate__animated animate__zoomIn animate__faster">
    <div class="relative w-16 h-16 mx-auto mb-4">
        <div class="absolute inset-0 bg-brand-accent blur-xl opacity-30 animate-pulse"></div>
        <div class="relative w-full h-full bg-brand-accent rounded-full flex items-center justify-center shadow-xl">
            <i data-lucide="check" class="text-white w-8 h-8"></i>
        </div>
    </div>
    
    <h3 class="text-xl font-bold mb-1 text-slate-900 dark:text-white">
        Access Restored
    </h3>
    
    <p class="text-slate-500 dark:text-slate-400 text-xs">
        Synchronizing credentials...
    </p>
</div>

            <div id="backToLogin" class="mt-6 pt-4 border-t border-slate-100 dark:border-slate-800 text-center">
                <a href="{% url user_type|add:':login' %}"
                    class="text-[9px] font-black uppercase tracking-[0.2em] text-slate-400 hover:text-brand-purple transition-all flex items-center justify-center gap-2">
                    <i data-lucide="arrow-left" class="w-3 h-3"></i> Return to {{ user_type|capfirst }} Terminal
                </a>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 1200, once: true });
        lucide.createIcons();

        // Theme Logic
        const themeBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const html = document.documentElement;

        function updateTheme(isDark) {
            if (isDark) {
                html.classList.add('dark');
                themeIcon.className = 'fas fa-sun text-yellow-400';
            } else {
                html.classList.remove('dark');
                themeIcon.className = 'fas fa-moon text-slate-600';
            }
        }

        updateTheme(localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches));

        themeBtn.addEventListener('click', () => {
            const isDark = !html.classList.contains('dark');
            localStorage.theme = isDark ? 'dark' : 'light';
            updateTheme(isDark);
        });

        // Toast System
        const toastContainer = document.getElementById('toast-container');

        function showToast(message, type = 'info') {
            // Remove existing error toasts if showing a new error
            if (type === 'error' || type === 'messages-error') {
                const existingErrors = toastContainer.querySelectorAll('.toast.error, .toast.messages-error');
                existingErrors.forEach(t => {
                    t.classList.add('hiding');
                    setTimeout(() => t.remove(), 400);
                });
            }

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            let icon = 'info';
            let iconColor = 'text-blue-500';

            if (type === 'success' || type === 'messages-success') {
                icon = 'check-circle';
                iconColor = 'text-emerald-500';
            } else if (type === 'error' || type === 'messages-error') {
                icon = 'alert-circle';
                iconColor = 'text-rose-500';
            }

            toast.innerHTML = `
                <div class="${iconColor}">
                    <i data-lucide="${icon}" class="w-6 h-6"></i>
                </div>
                <div class="flex-1">
                    <p class="text-xs font-bold text-slate-700 dark:text-slate-200">${message}</p>
                </div>
            `;

            toastContainer.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                if (toast.parentElement) {
                    toast.classList.add('hiding');
                    setTimeout(() => toast.remove(), 400);
                }
            }, 5000);
        }



        // Timer
        let timerInterval;
        function startTimer() {
            let timeLeft = 180;
            const resendBtn = document.getElementById('resendBtn');
            resendBtn.disabled = true;
            resendBtn.innerText = "Resend Code";

            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const min = Math.floor(timeLeft / 60);
                const sec = timeLeft % 60;
                document.getElementById('timer').innerText = `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    resendBtn.disabled = false;
                    resendBtn.classList.add('text-brand-purple');
                    resendBtn.classList.remove('text-slate-400');
                }
                timeLeft--;
            }, 1000);
        }

        async function resendOTP() {
            const forgotForm = document.getElementById('forgotForm');
            const userType = forgotForm.dataset.userType;
            const email = document.getElementById('userEmail').value;
            const resendBtn = document.getElementById('resendBtn');
            resendBtn.innerText = "Sending...";
            resendBtn.disabled = true;

            try {
                const formData = new FormData();
                formData.append('email', email);
                const url = `/${userType}/forgot-password/`;

                const res = await fetch(url, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast(data.message, "success");
                    document.getElementById('otpInput').value = '';
                    startTimer();
                } else {
                    showToast(data.message, "error");
                    resendBtn.disabled = false;
                }
            } catch (err) { showToast("Network Error", "error"); resendBtn.disabled = false; }
        }

        function goToStep(step) {
            const steps = [
                { id: 'forgotForm', desc: 'Phase 01: Identity Link', icon: 'fingerprint' },
                { id: 'otpForm', desc: 'Phase 02: Verification', icon: 'shield-check' },
                { id: 'resetForm', desc: 'Phase 03: Security Patch', icon: 'key' }
            ];

            const userType = document.getElementById('forgotForm').dataset.userType;

            document.querySelectorAll('form').forEach(f => f.classList.add('hidden'));
            document.querySelectorAll('.cyber-bar').forEach((bar, i) => {
                bar.classList.remove('active', 'completed');
                if (i + 1 < step) bar.classList.add('completed');
                else if (i + 1 === step) bar.classList.add('active');
            });

            if (step <= 3) {
                const current = steps[step - 1];
                document.getElementById(current.id).classList.remove('hidden');
                document.getElementById('step-desc').textContent = current.desc;
                document.getElementById('step-desc').className = 'text-brand-600 dark:text-white text-[9px] font-black uppercase tracking-[0.3em]';
                document.getElementById('header-icon').setAttribute('data-lucide', current.icon);
                lucide.createIcons();
                if (step === 2) startTimer();
            } else {
                document.getElementById('successState').classList.remove('hidden');
                document.getElementById('backToLogin').classList.add('hidden');
                document.getElementById('step-desc').textContent = "Process Complete";
                document.getElementById('step-desc').className = 'text-brand-600 dark:text-white text-[9px] font-black uppercase tracking-[0.3em]';
                setTimeout(() => { window.location.href = `/${userType}/login/`; }, 2500);
            }
        }

        function toggleLoading(formId, isLoading) {
            const form = document.getElementById(formId);
            const btn = form.querySelector('button[type="submit"]');
            btn.disabled = isLoading;
            btn.querySelector('.loader').classList.toggle('hidden', !isLoading);
            btn.querySelector('.btn-text').classList.toggle('opacity-50', isLoading);
            const icon = btn.querySelector('i');
            if (icon) icon.classList.toggle('hidden', isLoading);
        }

        // Form Handlers
        document.getElementById('forgotForm').onsubmit = async (e) => {
            e.preventDefault();
            const userType = e.target.dataset.userType;
            toggleLoading('forgotForm', true);
            try {
                const url = `/${userType}/forgot-password/`;

                const res = await fetch(url, {
                    method: 'POST',
                    body: new FormData(e.target),
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast(data.message, "success");
                    goToStep(2);
                } else {
                    showToast(data.message, "error");
                }
            } catch (err) { showToast("Server connection failed", "error"); }
            toggleLoading('forgotForm', false);
        };

        document.getElementById('otpForm').onsubmit = async (e) => {
            e.preventDefault();
            const forgotForm = document.getElementById('forgotForm');
            const userType = forgotForm.dataset.userType;
            toggleLoading('otpForm', true);
            try {
                const url = `/${userType}/verify-otp/`;
                const res = await fetch(url, {
                    method: 'POST',
                    body: new FormData(e.target),
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                const data = await res.json();
                if (data.status === 'success') {
                    showToast(data.message, "success");
                    goToStep(3);
                } else {
                    showToast(data.message, "error");
                }
            } catch (err) { showToast("Verification failed", "error"); }
            toggleLoading('otpForm', false);
        };

        // Validation Logic
        const pass = document.getElementById('new_pass');
        const conf = document.getElementById('conf_pass');

        const validate = () => {
            const v = pass.value;
            const c = conf.value;
            const r = {
                len: v.length >= 6,
                up: /[A-Z]/.test(v) && /[a-z]/.test(v),
                sp: /[0-9]/.test(v) && /[^A-Za-z0-9]/.test(v)
            };

            const updateUI = (id, valid) => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.color = valid ? '#10b981' : '#94a3b8';
                    const icon = el.querySelector('i');
                    if (icon) icon.style.opacity = valid ? '1' : '0.4';
                }
            };

            updateUI('req-len', r.len);
            updateUI('req-up', r.up);
            updateUI('req-sp', r.sp);

            const passwordsMatch = v === c && v !== "";
            conf.style.borderColor = (passwordsMatch) ? '#10b981' : '';

            return r.len && r.up && r.sp && passwordsMatch;
        };

        pass.oninput = validate;
        conf.oninput = validate;

        document.getElementById('resetForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!validate()) {
                showToast("Please meet all security requirements.", "error");
                return;
            }
            const forgotForm = document.getElementById('forgotForm');
            const userType = forgotForm.dataset.userType;
            toggleLoading('resetForm', true);
            try {
                const url = `/${userType}/reset-password/`;
                const res = await fetch(url, {
                    method: 'POST',
                    body: new FormData(e.target),
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                });
                const data = await res.json();
                if (data.status === 'success') {
                    // Success toast suppressed per user request (redundant with successState UI)
                    goToStep(4);
                } else {
                    showToast(data.message || "Update failed", "error");
                }
            } catch (err) { showToast("Server error. Please try again.", "error"); }
            toggleLoading('resetForm', false);
        };


    </script>
</body>

</html>